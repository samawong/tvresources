name: Upstream Sync

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: "ä¸Šæ¸¸ä»“åº“åˆ†æ”¯"
        required: true
        default: "main"
        type: string
      target_branch:
        description: "ç›®æ ‡ä»“åº“åˆ†æ”¯"
        required: true
        default: "main"
        type: string
      sync_strategy:
        description: "åŒæ­¥ç­–ç•¥"
        required: true
        default: "discard"
        type: choice
        options:
          - discard # å¼ºåˆ¶åŒæ­¥ï¼šä¸¢å¼ƒæœ¬åœ°ä¿®æ”¹ï¼Œå®Œå…¨å¤åˆ¶ä¸Šæ¸¸ (æŽ¨è)
          - merge   # å°è¯•åˆå¹¶ï¼šå¦‚æžœæœ‰å†²çªä¼šæŠ¥é”™

env:
  UPSTREAM_REPO: "cluntop/tvbox"
  UPSTREAM_BRANCH: ${{ github.event.inputs.upstream_branch || 'main' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}
  SYNC_STRATEGY: ${{ github.event.inputs.sync_strategy || 'discard' }}

jobs:
  sync_upstream:
    name: Sync and Notify
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TARGET_BRANCH }}
          repository: cluntop/tvbox
          token: ${{ secrets.GIT_TOKEN }}
          persist-credentials: true
          fetch-depth: 1

      - name: Sync Upstream Changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4.1
        with:
          upstream_sync_repo: ${{ env.UPSTREAM_REPO }}
          upstream_sync_branch: ${{ env.UPSTREAM_BRANCH }}
          target_sync_branch: ${{ env.TARGET_BRANCH }}
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_pull_args: ${{ env.SYNC_STRATEGY == 'discard' && '--allow-unrelated-histories --force' || '' }}
          target_branch_push_args: ${{ env.SYNC_STRATEGY == 'discard' && '--force' || '' }}
          test_mode: false

      - name: Generate Summary
        run: |
          echo "### ðŸ”„ åŒæ­¥æŠ¥å‘Š (Sync Report)" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **æºä»“åº“** | [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç»“æžœ** | ${{ steps.sync.outputs.sync_status == 'success' && 'âœ… æˆåŠŸ (Success)' || 'âŒ å¤±è´¥ (Failed)' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Delete Old Workflows
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 3
